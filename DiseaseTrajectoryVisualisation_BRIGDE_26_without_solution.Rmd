---
title: "BRIDGE course: Finding patterns in registry data: Disease trajectories "
author: "Isbaella Friis JÃ¸rgensen (isabella.jorgensen@cpr.ku.dk)"
date: "13/01/2026"
output: html_document
---

```{r setup, include=FALSE}
install.packages("rmarkdown")
library(rmarkdown)
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction

In this exercise you will to use R markdown and the Disease Trajectory Browser to investigate data from the National Patient Registry. You will try to visualize common disease trajectories from the Danish population.

### Learning Objectives

1)  Visualize registry-like data and understand ICD-10 structure and codes
2)  Use basic statistics to investigate comorbidities in registry-like data
3)  Understand the concept of disease trajectories
4)  Try different ways of visualizing disease trajectories
5)  Have fun ðŸ¥³

### Agenda for today

-   **Investigating registry-like data and comorbidities**
-   Disease pairs, linear age plot and sankey network visualization
-   Disease trajectories associated to survival using Sankey
-   Danish Disease Trajectory Browser and Cytoscape

### The programming language R

If you are not familiar with R and need help to understand what a function does, which variables you can modify etc., you can always use the questionmark to open a help page. For example does this show how the library command works. Click 'on the small green arrow' to run the code and see the output.

```{r, eval=T}
?library
```

For this command the output is shown in the lower, right corner.

For some of the code you will need to install the tidyverse, dplyr, networkD3 and alluvial packages. When running the code, just say 'no' when R asks if you want to restart prior to installation.

```{r, echo=TRUE, message=FALSE, results='hide', eval =FALSE, warning=FALSE, output = FALSE}
install.packages("tidyverse")
library(tidyverse)
install.packages("dplyr")
library(dplyr)
install.packages("ggplot2")
library(ggplot2)
install.packages("networkD3")
library(networkD3)
install.packages("alluvial")
library(alluvial)
```

### Investigating registry-like data:

## 1) LOAD THE DATA FILES INTO R

We have created a simulated data set that is similar to registry type data. There are two files from the registry:

-   A cpr-file *cpr.tsv* that contains: patient information.
-   A lpr-file *lpr.tsv* that contains: information about the patients' stay at the hospital.

Read the two files into R. You can use the read.csv command. This will read and save the files as a data frame. A data frame has the variables of a data set as columns and the observations as rows. It is specified that the file has a header and that the columns are split by tabs.

```{r}
# read in the files, cpr.tsv and lpr.tsv

```

## 2) TAKE A LOOK AT THE DATA

Take a look at the files and try to understand the files.

**Q: Which column do you think contains the diagnoses of the patients?**

**Q: How big are the files/How many lines do they contain?**

HINT: The "head" command shows the first lines of the files and the "str" command to inspect the structure of the files.

```{r}
# Type your own commands to see what each of the files contain here: 

```

**Q: What is the ICD-10 code for pancreatic cancer?** (HINT: look it up online, remember there's a small difference between the Danish and international versions of ICD-10)

**Q: How many times is pancreatic cancer diagnosed in the registry??**

```{r}

```

Now that you have familiarized yourself a bit with the format of cpr.tsv and lpr.tsv, we will try to visualize the data and do some basic statistics.

First, you should combine the files for one larger data frame merged by the PID column. For convenience with the subsequent analyses, we suggest you called the combined data frame "merge_cpr_lpr".

HINT: The "merge" command merges two data frames by common columns.

```{r}
# Type your own commands to merge the files here: 

```

Now we could for example calculate the age for each individual at each diagnosis to visualize ages for specific diagnoses.

**Q: What is the mean age for any diagnosis in the registry? Does it sound realistic?**

```{r}
# Type your own commands to convert birthday and diagnosis date to date format

# Type your own commands to calculate the age at each diagnosis 

# calculate the mean age at any diagnosis 


```

Now you should try to visualize the age at diagnosis in a simple plot.

**Q: Does it look realistic? Why/Why not?**

```{r}
# plot the age at diagnosis


```

Try to count the how many times each diagnosis is given in the registry.

**Q: What are the three most common diagnoses? Is this realistic?**

```{r}
## Count how many times each diagnosis is given

```

Now it becomes a bit more advanced. Try to calculate the top 10 occurring comorbidities in the registry.

**Q: What is the top 10 most common comorbidities? Is this realistic?**

```{r}

# Keep unique patient-diagnosis combinations 


# Split diagnoses by patient

# Function to generate diagnosis pairs


# Generate all diagnosis pairs

# Count comorbidities

# Top 10 comorbid diagnosis pairs 

```

You are now done with the first initial look at the registry-like data as well as some basic statistics and visualizations of the data. This type of data have been used to create disease trajectories for the Danish population. You can wait till all are done with this part and we move on with the disease trajectory 'lecture' or you can slowly start to read about disease trajectories yourself (see below).

## Disease pairs, linear age plot and Sankey network visualization

### The theory behind creating Disease trajectories

A disease co-occurrence algorithm was developed to investigate comorbidities and longer, temporal disease trajectories in the Danish population (Jensen et al., 2014). The key steps in the algorithm is seen on the figure below.

1)  Different colors of the patients illustrate different comorbidities and each color corresponds to a specific chapter in the ICD-10 terminology (step 1 in Figure).

2)  All possible combinations of disease co-occurrences (D1 with D2) in the population are tested to find diseases that co-occur significantly more often together compared to their individual frequencies (step 2 in Figure 1). The relative risk (RR) is used to evaluate the strength of the correlation between disease co-occurrences. Comparison groups of N =10,000 random patients are matched on birth decade, sex, type of hospital encounter and discharge week. Occurrences of D2 in this matched comparison group were calculated and show how prevalent the co-occurrence of D1 and D2 are in the general population. P-values for each RR were found using a binomial distribution. All disease pairs (D1 and D2) with an RR \> 1 and p-value \< 0.001 were included as significant disease co-occurrences.

3)  All significant disease co-occurrences were tested for directionality with binomial tests to identify pairs where significantly more patients had D1 diagnosed before D2 or the other way around (Figure, step 3). P-values were corrected for multiple testing using Bonferroni correction and found significant if the corrected p-value \< 0.05.

4)  Significant directed disease pairs are combined into longer trajectories of overlapping diagnoses (Figure, step 4). Typically, we required that at least 20 patients follow the entire trajectory, thus in this case, have all four diagnoses (D1-\> D2 -\> D3 -\> D4) in the order specified by the trajectory.

5)  Numerous disease trajectories can be visualized as a disease progression network with edges linking directed disease pairs, showing how frequent alternative disease paths are followed over time (Figure, step 5).

![Creation of disease trajectories](Siggaard_et_al_Figure5.png){width="700"}

For more detail about the disease trajectory method see;

Jensen, A.B., Moseley, P., Oprea, T., Ellesoe, S.G., Eriksson, R., Schmock, H., Jensen, P.B., Jensen, L.J., Brunak, S. Temporal disease trajectories condensed from population-wide registry data covering 6.2 million patients. Nat Commun 5, 4022 (2014). <https://doi.org/10.1038/ncomms5022>

Siggaard, T., Reguant, R., JÃ¸rgensen, I.F., Haue, A.D., Lademann, M., Aguayo-Orozco, A., Hjaltelin, J.X., Jensen A.B., Banasik, K., Brunak, S. Disease trajectory browser for exploring temporal, population-wide disease progression patterns in 7.2 million Danish patients. Nat Commun 11, 4952 (2020). <https://doi.org/10.1038/s41467-020-18682-4>

## 3) TIME TO LOOK AT DISEASE PAIRS AND TRAJECTORIES

We have cheated a little and prepared disease trajectories in advance (as it would take to long for you to do it during this class). We created two files;

-   A pairs-file *pairs.tsv* that contains: pairs of disease co-occurrences in the National Patient Registry
-   A trj-file *trj.tsv* that contains: disease trajectories with 3 consecutive disease for pancreatic cancer

Read the two files into R. You can use the read.csv command. This will read and save the files as a data frame. A data frame has the variables of a data set as columns and the observations as rows. It is specified that the file has a header and that the columns are split by tabs.

```{r}
# read in the files paris.tsv and trj.tsv
```

Take a look at the files and try to understand the files.

**Q: What columns do each of the files contain?**

```{r}
# Type your own commands to see what each of the files contain here: 


```

We will start out with visualizing the disease pairs, hence all of the diseases that co-occur more together than expected based on the individual frequencies.

First you should filter the pairs file so it only includes pairs including the diagnosis of pancreatic cancer.

```{r}
# Find all pairs including pancreatic cancer

```

Then we will plot the pancreatic cancer disease pairs and the mean age for diagnosis for each of them. AGE_AT_D1 is the mean age at the first diagnosis and CODE_DIFF_DAYS is the difference in days between the two diagnoses.

```{r}
# define colors of ICD-10 chapters
colorCodes = c(A = "#2FCFD3", C="#9E4F46", D = "#F69EDC", E= "#FF1AB9", F = "#2DC92D", G = "#004DE6", K = "#008495")


## Color look up:
pairs$col1 = as.matrix(colorCodes[substr(pairs$D1,1,1)])
pairs$col2 = as.matrix(colorCodes[substr(pairs$D2,1,1)])

# create name for each trajectory and order file according to age at diagnose
pairs$name = paste(pairs$D1, pairs$D2, sep = "_")
pairs$name = factor(pairs$name, levels = pairs$name[order(pairs$AGE_AT_D1)])

# create plot
library(ggplot2)
ggplot(data=pairs, aes()) +
  geom_segment(aes(x=(AGE_AT_D1/365.25), xend=((AGE_AT_D1+CODE_DIFF_DAYS)/365.25),y=name, yend =name), linewidth = pairs$counts/200, alpha=.7, col="grey") +
  geom_point(aes(x=(AGE_AT_D1/365.25), y=name,colour=col1), size =8, alpha=1) + 
  geom_text(aes(x=(AGE_AT_D1/365.25), y=name,label=D1),size=2, colour="white") +
  geom_point(aes(x=((AGE_AT_D1+CODE_DIFF_DAYS)/365.25), y=name, colour=col2),size =8, alpha=1) + 
  geom_text(aes(x=((AGE_AT_D1+CODE_DIFF_DAYS)/365.25), y=name, label=D2),size=2,colour="white") +
  scale_colour_identity() + theme(text = element_text(size = 12)) + theme_minimal() +
  xlab("Age at first diagnosis") + ylab(" ") + 
  ggtitle("Pancreatic cancer disease pairs") + 
  theme(plot.title = element_text(color="black", size=12),
        axis.ticks.y = element_blank())
```

**Q: Which disease pairs have the oldest and the youngest mean age for the diagnosis of pancreatic cancer?**

You will now try to visualize the disease pairs in one type of Sankey diagram.

```{r}
# load relevant packages
library(tidyverse)
library(networkD3)

# create nodes from the two diseases:
nodes = data.frame(names=c(as.character(pairs$D1), as.character(pairs$D2)) %>% unique())

# define source and target:
pairs$IDsource = match(pairs$D1, nodes$names)-1
pairs$IDtarget = match(pairs$D2, nodes$names)-1            

nodes$group = as.factor(substr(nodes$names, 0,1))

# define colors
my_color = 'd3.scaleOrdinal() .domain(["A", "C", "D", "E", "F", "G", "K"])
.range(["#2FCFD3", "#9E4F46", "#F69EDC", "#FF1AB9", "#2DC92D", "#004DE6", "#008495"])'

# create sankey network:
sankeyNetwork(Links = pairs, Nodes = nodes, Source ="IDsource", Target = "IDtarget", Value = "counts", NodeID = "names", 
  sinksRight =T, fontSize =0, fontFamily=NULL, nodeWidth = 10, nodePadding = 5, margin = NULL, height = 300, width=600, iterations= 32, colourScale=my_color, NodeGroup="group") 
```

**Q: You can try to change some of the variables in the creation of the Sankey, the colors, or just drag the nodes around to optimize the network**

## Danish Disease Trajectory Browser

The Danish Disease Trajectory Browser (DTB) is a tool for exploring almost 25 years of data from the Danish National Patient Register, <http://dtb.cpr.ku.dk>. In the data set comprising 7.2 million patients and 122 million admissions, users can identify diagnosis pairs with statistically significant directionality and combine them to linear disease trajectories. Users can search for one or more disease codes (ICD-10 classification) and explore disease progression patterns via an array of functionalities.

Here you can see a small video of some of the most basic features of the DTB:

<https://www.youtube.com/watch?v=wCeQZeCBGRo>

1)  Go to dtb.cpr.ku.dk

2)  Search for 'C25 Malignant neoplasm of pancreas' *OR your favorite disease of interest!*

3)  How many linear trajectories show up? (HINT: In the upper, right corner you can find small videos about usage of the dtb).

4)  Go to the 'search' tab at the right sidebar and set the relative risk to be above 2 and minimum 100 patients (you can choose your own search filters if you choose your own disease previously!)

5)  How many linear trajectories show up now?

6)  Turn network view on (next to the search field in the top). Move the nodes around so you can better see both nodes and edges. Which edge (between which to nodes) does to most patient follow?

7)  Click on this edge. What is the relative risk and the p-value for these two diseases?

8)  Go to the 'search' tab at the right sidebar and change the edge annotation to relative risk. Which edge (between which to nodes) has the highest relative risk?

9)  Click on this edge. How many patients have the two diseases?

10) Click on C25 (or the favorite disease you searched for), highlight incoming and outgoing edges and delete everything else. Now you have only the diseases which are found to co-occur significantly more with C25 compared to the individual frequencies of the two in the Danish population.

11) Now we want to look at bit closer into the sex differences in the C25 cancer trajectories. Go to the 'search' tab at the right sidebar under 'sex' and select "females patients only" - remember to click 'search with filter'. Go to the information tab and 'download data as' 'JSON for Cystoscape Desktop'. The file should now be downloaded.

12) Go back and select male patients only. Download this network as JSON file as well.

13) Open Cytoscape and import the files you just downloaded (menu: File -\> Import -\> Network from file...) Make sure you rename the networks, so you know which one is the female network and which one is the male network. Rename a network by right-cliciking on it, "rename network..".

14) In the control panel (left) select the "Style" tab. Make sure you are editing "Node" style.

15) Color: In the "Fill color" property, press the map button. "Column" should be "color", "Mapping type" should be "passthrough mapping".

16) Name: In the "Label" property, press the map button. "Column" should be "name", "Mapping type" should be "passthrough mapping".

17) Now, make sure you are editing "Edge" style. Change the width of the edges by clicking "Width" parameter and under "column" choose "nPatients" and "Mapping Type" choose "Continuous Mapping". You can double-click the "current mapping" graph and adjust the thickness of the edges so that edges with few patients thinner or edges with many patients thicker.

Now it is time to discover which nodes/disease are in females and males, only.

18. Go to 'tools' in the menu-bar, 'merge' and 'networks'. Choose both the male and female networks and move them to the right 'networks to merge' box. Make sure to choose 'difference' and check the box 'Remove all nodes that are in the 2nd network'. And click 'merge'. You now get the difference between the first and the second network.
19. Do the same thing again, but remember to change the order in which you drag the networks to the 'networks to merge' box. You now get the difference between the first and the second network.
20. Which diseases are present in the female network and not the male network? Which diseases are present in the male network and not the female network?
21. Go back to one of the main female or male networks. Play around with the network. Add labels, change styles and format and move the nodes around until you are satisfied with your disease trajectory network.
22. Be proud! You have now visualized and analyze both registry-like data and different disease trajectories!

## Thank you for your time and participation!
